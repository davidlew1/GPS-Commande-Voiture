<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Localisation</title>
  <script>
    const scriptURL = "https://script.google.com/macros/s/AKfycbyzp5OBxiya8wyAF-miJ5pzz29hzHCtcFDNDpTj77gm7DSU6UUYLO0jGFLvc3C98C_l/exec";

    async function sendLocation() {
      try {
        // Obtenir la position GPS
        const position = await new Promise((resolve, reject) => {
          if (!navigator.geolocation) {
            reject(new Error("Géolocalisation non disponible."));
          }
          navigator.geolocation.getCurrentPosition(resolve, reject);
        });

        const latitude = position.coords.latitude;
        const longitude = position.coords.longitude;

        // ⚠️ Envoi correct via POST (vers doPost)
        await fetch(scriptURL, {
          method: "POST",
          headers: {
            "Content-Type": "application/x-www-form-urlencoded"
          },
          body: `id=test&latitude=${latitude}&longitude=${longitude}`
        });

        // 🔄 Appel à doGet pour récupérer l’URL
        const urlResp = await fetch(`${scriptURL}?data=url`);
        const urlText = await urlResp.text();

        // 🔄 Appel à doGet pour récupérer le message
        const msgResp = await fetch(`${scriptURL}?data=message`);
        const msgText = await msgResp.text();

        // 🔊 Lecture vocale
        const utterance = new SpeechSynthesisUtterance(msgText);
        speechSynthesis.speak(utterance);

        // ✅ Redirection après 4 secondes
        setTimeout(() => {
          window.location.href = urlText.trim();
        }, 4000);

      } catch (error) {
        alert("Erreur : " + error.message);
      }
    }

    window.onload = sendLocation;
  </script>
</head>
<body>
  <h1>Envoi de la localisation...</h1>
</body>
</html>
